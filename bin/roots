#!/usr/bin/env node

var fs = require('fs');
var path = require('path');
var colors = require('colors');
var watch = require('watch');
var _ = require('underscore');
var readdirp = require('readdirp');
var coffeescript = require('../lib/compilers/coffee');
var helpers = require('../lib/helpers');

var current_directory = path.normalize(process.cwd());
var dir_contents = fs.readdirSync(current_directory);

// pulls out only the type of file you pass it in the directory you pass it
var get_files = function(dir, type){ 
  var all_files = fs.readdirSync(path.join(current_directory, dir));
  return _.filter(all_files, function(f){ return !!f.match(new RegExp('\.' + type + '$')); });
}

// could move this out to helpers
var pass_through = function(type){
  readdirp({ root: path.join(current_directory, 'assets'), fileFilter: '*.' + type }, function(err, res){
    res.files.forEach(function(file){
      var location = path.join(current_directory, 'assets', file.path);
      var destination = path.join(current_directory, 'public', file.path);
      var contents = fs.readFileSync(location, 'utf8');
      fs.writeFileSync(destination, contents);
    });
  });
}

var create_directories = function(cb){
  readdirp({ root: path.join(current_directory, 'assets') }, function(err, res){
    res.directories.forEach(function(dir){
      helpers.mkdirp(path.join('public', dir.path), '0777', function(){ cb(); })
    });
  });
}

// make sure this is a roots project

if (_.include(dir_contents, 'package.json')) {
  // console.log('we have a legit app'.green);
} else {
  // console.log('looks like youre missing the app.js file, try running roots new `name` to create a new project'.red);
}

// compile all the things!
create_directories(function(){

  // compile javascript
  coffeescript.compile(get_files('assets/js', 'coffee'));
  pass_through('js');

  // compile css

  // compile views
});

// serve to public and open the browser

// create a watch task that does this on file change

// create a websockets server to interact with livereload and push changes live