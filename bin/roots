#!/usr/bin/env node

var fs = require('fs'),
    path = require('path'),
    colors = require('colors'),
    watch = require('nodewatch'),
    compiler = require('../lib/compile-project'),
    server = require('../lib/server');

var current_directory = path.normalize(process.cwd());

// --------------------------------------------------------------------------
// config variables (these will come from app.js)
// --------------------------------------------------------------------------

var options = {};
options.file_types = ['js', 'css', 'html', 'coffee', 'styl', 'jade', 'haml', 'ejs'];
options.ignore_files = [];
options.ignore_files.push(/^_/);
options.folder_config = { assets: 'assets', views: 'views' }
// add locals here, make sure to include a repeat(x) helper

// --------------------------------------------------------------------------
// compile entire project fresh
// --------------------------------------------------------------------------

server.start(current_directory);
compiler.compile_project(options);

// --------------------------------------------------------------------------
// now let's keep an eye on the files and recompile when necessary
// --------------------------------------------------------------------------

watch.add("./" + options.folder_config.assets).add("./" + options.folder_config.views).onChange(function(f, prev, curr, action){
  compiler.compile_project(options, function(){
    server.reload();
  });
});