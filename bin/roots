#!/usr/bin/env node

var fs = require('fs'),
    path = require('path'),
    colors = require('colors'),
    compiler = require('../lib/compile-project'),
    server = require('../lib/server'),
    watcher = require('../lib/watcher');

var current_directory = path.normalize(process.cwd());

// --------------------------------------------------------------------------
// config variables (these will come from app.js)
// --------------------------------------------------------------------------

require('coffee-script');
var options = require(current_directory + '/app.coffee'); // pull the app config file

// hard coded until a plugin interface is developed
options.file_types.html = ['jade', 'ejs', 'html'];
options.file_types.css = ['styl', 'css'];
options.file_types.js = ['coffee', 'js'];

// make sure all layout files are ignored
for (var key in options.layouts){
  options.ignore_files.push(new RegExp(options.layouts[key]));
}

// add any additional globally available locals here
// - range(1, 100).forEach

// --------------------------------------------------------------------------
// compile entire project fresh
// --------------------------------------------------------------------------

server.start(current_directory);
compiler.compile_project(options);

// --------------------------------------------------------------------------
// now let's keep an eye on the files and recompile when necessary
// --------------------------------------------------------------------------

watcher.watchDirectories(["./" + options.folder_config.views,
                          "./" + options.folder_config.assets], function() {
                            compiler.compile_project(options, function() {
                              server.reload();
                            });
                        });